<?php
/**
 * @file
 * Code for the Off Categories Feature feature.
 */

include_once 'off_categories_feature.features.inc';

/**
 * Implements hook_menu().
 */

function off_categories_feature_menu() {
  $items['taxonomy/category/add'] = array(
    'page callback' => 'off_categories_feature_term_add_page',
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Provide users with a term add page for the category vocaculary.
 *
 * @return array
 *   A Drupal build array.
 */

function off_categories_feature_term_add_page() {
  // Set og context from url query.
  $params = drupal_get_query_parameters();
  if (!empty($params['og_group_ref'])) {
    $group = node_load($params['og_group_ref']);
    og_context('node', $group);
  }

  // Build taxonomy form.
  module_load_include('inc', 'taxonomy', 'taxonomy.admin');
  $vocabulary = taxonomy_vocabulary_machine_name_load('category');
  drupal_set_title($title = $vocabulary->name, $output = CHECK_PLAIN);
  $form_id = 'taxonomy_form_term';
  //drupal_get_form('taxonomy_form_term', $form, &$form_state, $edit = array(), $vocabulary);
  $edit = array();
  return drupal_render(drupal_get_form($form_id, $edit, $vocabulary));
}

/**
 * Implements hook_hierarchical_select_valid_item().
 */
function off_feature_hierarchical_select_valid_item($item, $params) {

  if (!is_numeric($item) || $item < 1 ) {
    return FALSE;
  }

  $term = taxonomy_term_load($item);
  if (!$term) {
    return FALSE;
  }

  $group = og_context();
  $group_type = 'node';
  $entity_type = 'term';
  return (og_is_member($group_type, $group['gid'], $entity_type, $user));
}

// Empty hierarchical select hooks return standard behaviour. This is required
// for some reason.
function off_feature_hierarchical_select_params() {
  return hs_taxonomy_hierarchical_select_params();
}

function off_feature_hierarchical_select_root_level() {
  return hs_taxonomy_hierarchical_select_root_level();
}

function off_feature_hierarchical_select_children() {
  return hs_taxonomy_hierarchical_select_children();
}

function off_feature_hierarchical_select_lineage() {
  return hs_taxonomy_hierarchical_select_lineage();
}

function off_feature_hierarchical_select_item_get_label($item, $params) {
  return hs_taxonomy_hierarchical_select_item_get_label();
}

function off_feature_hierarchical_select_create_item($label, $parent, $params) {
  return hs_taxonomy_hierarchical_select_create_item();
}

function off_feature_hierarchical_select_entity_count() {
  return hs_taxonomy_hierarchical_select_entity_count();
}

function off_feature_hierarchical_select_implementation_info() {
  return hs_taxonomy_hierarchical_select_implementation_info();
}

function off_feature_hierarchical_select_config_info() {
  return hs_taxonomy_hierarchical_select_config_info();
}

